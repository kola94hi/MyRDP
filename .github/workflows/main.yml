name: RDP with Internet Sharing

on:
  workflow_dispatch:

jobs:
  secure-rdp:
    runs-on: windows-latest
    timeout-minutes: 35

    steps:
      - name: Configure Core RDP Settings
        run: |
          Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server' -Name "fDenyTSConnections" -Value 0 -Force
          Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp' -Name "UserAuthentication" -Value 0 -Force
          Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp' -Name "SecurityLayer" -Value 0 -Force

          netsh advfirewall firewall delete rule name="RDP-Tailscale"
          netsh advfirewall firewall add rule name="RDP-Tailscale" dir=in action=allow protocol=TCP localport=3389

          Restart-Service -Name TermService -Force

      - name: Create RDP User with Secure Password
        run: |
          # Generar contrase√±a m√°s simple y visible
          $password = "RDP123!password"
          
          # Crear usuario
          $securePass = ConvertTo-SecureString $password -AsPlainText -Force
          New-LocalUser -Name "RDPUser" -Password $securePass -AccountNeverExpires
          Add-LocalGroupMember -Group "Administrators" -Member "RDPUser"
          Add-LocalGroupMember -Group "Remote Desktop Users" -Member "RDPUser"
          
          # Mostrar contrase√±a CLARAMENTE en los logs
          Write-Host "=========================================="
          Write-Host "CREDENCIALES RDP - COPIA Y PEGA:"
          Write-Host "USUARIO: RDPUser"
          Write-Host "CONTRASE√ëA: RDP123!password"
          Write-Host "=========================================="
          
          # Tambi√©n guardar en variables
          echo "RDP_USER=RDPUser" >> $env:GITHUB_ENV
          echo "RDP_PASSWORD=RDP123!password" >> $env:GITHUB_ENV

      - name: Install Tailscale
        run: |
          $tsUrl = "https://pkgs.tailscale.com/stable/tailscale-setup-latest-amd64.msi"
          $installerPath = "$env:TEMP\tailscale.msi"
          Invoke-WebRequest -Uri $tsUrl -OutFile $installerPath
          Start-Process msiexec.exe -ArgumentList "/i", "`"$installerPath`"", "/quiet", "/norestart" -Wait
          Remove-Item $installerPath -Force

      - name: Configure Tailscale as Exit Node
        run: |
          Write-Host "üîß Configurando Tailscale como nodo de salida..."
          
          # Configurar Tailscale como exit node
          & "$env:ProgramFiles\Tailscale\tailscale.exe" up --authkey=${{ secrets.TAILSCALE_AUTH_KEY }} --hostname=gh-runner-$env:GITHUB_RUN_ID --advertise-exit-node --accept-routes
          
          # Esperar a que Tailscale se conecte
          Start-Sleep -Seconds 10
          
          $tsIP = $null
          $retries = 0
          while (-not $tsIP -and $retries -lt 10) {
              $tsIP = & "$env:ProgramFiles\Tailscale\tailscale.exe" ip -4
              Start-Sleep -Seconds 5
              $retries++
          }
          
          if (-not $tsIP) {
              Write-Error "Tailscale IP not assigned. Exiting."
              exit 1
          }
          echo "TAILSCALE_IP=$tsIP" >> $env:GITHUB_ENV
          Write-Host "‚úÖ Tailscale IP: $tsIP"

      - name: Configure Internet Sharing via Hotspot
        run: |
          Write-Host "üåê Configurando compartir internet a trav√©s de Hotspot..."
          
          # Verificar soporte de hotspot
          $wlanDrivers = netsh wlan show drivers
          $hostedNetworkSupported = $wlanDrivers | Select-String "Hosted network supported" | ForEach-Object { $_.ToString().Split(':')[1].Trim() }
          
          if ($hostedNetworkSupported -eq "Yes") {
              Write-Host "‚úÖ Hardware compatible con Hotspot"
              
              # Configurar hotspot
              $hotspotName = "Tailscale-Internet"
              $hotspotPassword = "Share123!"
              
              netsh wlan set hostednetwork mode=allow ssid=$hotspotName key=$hotspotPassword
              netsh wlan start hostednetwork
              
              Write-Host "üì∂ Hotspot creado:"
              Write-Host "   SSID: $hotspotName"
              Write-Host "   Password: $hotspotPassword"
              
              echo "HOTSPOT_SSID=$hotspotName" >> $env:GITHUB_ENV
              echo "HOTSPOT_PASSWORD=$hotspotPassword" >> $env:GITHUB_ENV
              echo "HOTSPOT_ENABLED=true" >> $env:GITHUB_ENV
              
          } else {
              Write-Host "‚ö†Ô∏è  Hotspot no disponible, configurando solo Tailscale Exit Node"
              echo "HOTSPOT_ENABLED=false" >> $env:GITHUB_ENV
          }

      - name: Configure Network Bridge for Internet Sharing
        run: |
          Write-Host "üîó Configurando puente de red para compartir internet..."
          
          try {
              # Obtener interfaces de red
              $tsAdapter = Get-NetAdapter | Where-Object { $_.InterfaceDescription -like "*Tailscale*" }
              $hotspotAdapter = Get-NetAdapter | Where-Object { $_.InterfaceDescription -like "*Hosted*" }
              
              Write-Host "Interfaces detectadas:"
              Write-Host "  - Tailscale: $($tsAdapter.Name)"
              if ($hotspotAdapter) {
                  Write-Host "  - Hotspot: $($hotspotAdapter.Name)"
              }
              
              # Configurar IP est√°tica para el hotspot si existe
              if ($hotspotAdapter -and $env:HOTSPOT_ENABLED -eq 'true') {
                  Write-Host "üì° Configurando red hotspot..."
                  netsh interface ip set address "Wi-Fi" static 192.168.137.1 255.255.255.0
                  
                  # Configurar DHCP simulado para dispositivos conectados
                  Write-Host "üîÑ Configurando servicio DHCP b√°sico..."
                  
                  # Habilitar compartir conexi√≥n a nivel de firewall
                  netsh advfirewall firewall add rule name="Hotspot Internet" dir=in action=allow protocol=ANY localport=ANY
                  netsh advfirewall firewall add rule name="Hotspot Internet Out" dir=out action=allow protocol=ANY localport=ANY
                  
                  Write-Host "‚úÖ Red hotspot configurada: 192.168.137.1/24"
              }
              
              # Configurar pol√≠ticas de enrutamiento
              Write-Host "üõ£Ô∏è  Configurando enrutamiento..."
              
              # Habilitar IP forwarding
              Set-ItemProperty -Path "HKLM:\SYSTEM\CurrentControlSet\Services\Tcpip\Parameters" -Name "IpEnableRouter" -Value 1 -Type DWord
              
              # Configurar NAT b√°sico para compartir internet
              netsh interface portproxy reset
              
              Write-Host "‚úÖ Enrutamiento configurado"
              
          } catch {
              Write-Host "‚ö†Ô∏è  Algunas configuraciones de red no pudieron aplicarse: $($_.Exception.Message)"
              Write-Host "üí° El compartir internet puede requerir configuraci√≥n manual via RDP"
          }

      - name: Enable Remote Desktop Internet Sharing Features
        run: |
          Write-Host "üñ•Ô∏è  Habilitando funciones de compartir internet en RDP..."
          
          # Configurar RDP para permitir redirecci√≥n de recursos
          Set-ItemProperty -Path 'HKLM:\SOFTWARE\Policies\Microsoft\Windows NT\Terminal Services' -Name "fDisableCdm" -Value 0 -Force
          Set-ItemProperty -Path 'HKLM:\SOFTWARE\Policies\Microsoft\Windows NT\Terminal Services' -Name "fEnableCdm" -Value 1 -Force
          
          # Habilitar acceso a unidades locales via RDP
          Set-ItemProperty -Path 'HKLM:\SOFTWARE\Policies\Microsoft\Windows NT\Terminal Services' -Name "RedirectDrives" -Value 1 -Force
          
          # Configurar para mejor rendimiento de red
          Set-ItemProperty -Path 'HKLM:\SYSTEM\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp' -Name "MaxMonitors" -Value 4 -Force
          Set-ItemProperty -Path 'HKLM:\SYSTEM\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp' -Name "MaxXResolution" -Value 4096 -Force
          Set-ItemProperty -Path 'HKLM:\SYSTEM\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp' -Name "MaxYResolution" -Value 2160 -Force
          
          Write-Host "‚úÖ Funciones RDP mejoradas para compartir internet"

      - name: Create Internet Sharing Instructions Script
        run: |
          Write-Host "üìù Creando script de instrucciones para compartir internet..."
          
          $instructions = @"
# üöÄ INSTRUCCIONES PARA COMPARTIR INTERNET

## CONFIGURACI√ìN ACTUAL:
- ‚úÖ Tailscale configurado como Exit Node
- ‚úÖ RDP activado con usuario: RDPUser
- ‚úÖ Hotspot: $env:HOTSPOT_SSID (si est√° disponible)

## C√ìMO COMPARTIR INTERNET:

### OPCI√ìN 1: Usar Tailscale como VPN para otros dispositivos
1. Instala Tailscale en tus otros dispositivos
2. Con√©ctate a tu red Tailscale
3. Configura este runner como Exit Node:
   - Ve a: https://login.tailscale.com/admin/machines
   - Encuentra: gh-runner-$env:GITHUB_RUN_ID
   - Haz clic en "..." ‚Üí "Use as exit node"

### OPCI√ìN 2: Hotspot directo (si disponible)
1. Con√©ctate al WiFi: $env:HOTSPOT_SSID
2. Password: $env:HOTSPOT_PASSWORD
3. Configura IP manual: 192.168.137.x
4. Gateway: 192.168.137.1

### OPCI√ìN 3: Configuraci√≥n manual via RDP
1. Con√©ctate via RDP a: $env:TAILSCALE_IP
2. Una vez conectado:
   - Abre "Configuraci√≥n de Red"
   - Ve a "Estado" ‚Üí "Centro de redes y recursos compartidos"
   - Haz clic en "Conexi√≥n de Tailscale"
   - Ve a "Propiedades" ‚Üí "Compartir"
   - Marca "Permitir a otros usuarios..."
   - Selecciona la conexi√≥n hotspot o Ethernet

## COMANDOS √öTILES en RDP:
- Ver estado Tailscale: 
  tailscale status
- Ver IPs asignadas: 
  tailscale ip
- Reiniciar hotspot: 
  netsh wlan start hostednetwork

## DISPOSITIVOS CONECTADOS:
- Todos los dispositivos en tu red Tailscale pueden usar este internet
- Ancho de banda: Alta velocidad de GitHub Actions
- Seguridad: Todo encriptado via Tailscale
"@
          
          # Guardar instrucciones en archivo
          $instructions | Out-File -FilePath "$env:TEMP\internet_sharing_instructions.txt" -Encoding UTF8
          Write-Host "‚úÖ Script de instrucciones creado en RDP: C:\Temp\internet_sharing_instructions.txt"

      - name: Display Final Connection Info with Internet Sharing
        run: |
          Write-Host ""
          Write-Host "üéØ CONEXI√ìN RDP + COMPARTIR INTERNET LISTA"
          Write-Host "================================================"
          Write-Host "üìç DIRECCI√ìN RDP: $env:TAILSCALE_IP"
          Write-Host "üë§ USUARIO: RDPUser"
          Write-Host "üîë CONTRASE√ëA: RDP123!password"
          Write-Host ""
          
          if ($env:HOTSPOT_ENABLED -eq 'true') {
              Write-Host "üì∂ HOTSPOT WIFI:"
              Write-Host "   SSID: $env:HOTSPOT_SSID"
              Write-Host "   PASSWORD: $env:HOTSPOT_PASSWORD"
              Write-Host "   RED: 192.168.137.1/24"
          }
          
          Write-Host "üåê COMPARTIR INTERNET:"
          Write-Host "   ‚úÖ Tailscale configurado como Exit Node"
          Write-Host "   üîÑ Puedes compartir esta conexi√≥n a otros dispositivos"
          Write-Host "   üì° Ancho de banda de GitHub Actions disponible"
          Write-Host "================================================"
          Write-Host ""
          Write-Host "üìù INSTRUCCIONES RDP:"
          Write-Host "1. Con√©ctate a: $env:TAILSCALE_IP"
          Write-Host "2. Usuario: RDPUser"
          Write-Host "3. Contrase√±a: RDP123!password"
          Write-Host ""
          Write-Host "üîÑ PARA COMPARTIR INTERNET:"
          Write-Host "1. En RDP: Abre Centro de redes"
          Write-Host "2. Comparte conexi√≥n Tailscale con otras interfaces"
          Write-Host "3. O usa Tailscale como Exit Node para otros dispositivos"
          Write-Host ""
          Write-Host "üí° Script de instrucciones en: C:\Temp\internet_sharing_instructions.txt"

      - name: Wait 30 Minutes with Connection Monitoring
        run: |
          $endTime = (Get-Date).AddMinutes(30)
          Write-Host "‚è∞ Sesi√≥n activa por 30 minutos - Termina a las $($endTime.ToString('HH:mm:ss'))"
          Write-Host "üåê Monitoreando conexiones y uso de internet..."
          
          while ((Get-Date) -lt $endTime) {
              $remaining = $endTime - (Get-Date)
              $minutes = [math]::Floor($remaining.TotalMinutes)
              $seconds = $remaining.Seconds
              
              Write-Host "--- Estado de la sesi√≥n ---"
              Write-Host "‚è±Ô∏è  Tiempo restante: $minutes min $seconds seg"
              
              # Verificar estado Tailscale
              try {
                  $tsStatus = & "$env:ProgramFiles\Tailscale\tailscale.exe" status --json | ConvertFrom-Json
                  Write-Host "üîó Tailscale: $($tsStatus.BackendState)"
                  Write-Host "üìç IP: $env:TAILSCALE_IP"
              } catch {
                  Write-Host "üîó Tailscale: Error verificando estado"
              }
              
              # Verificar hotspot si est√° activo
              if ($env:HOTSPOT_ENABLED -eq 'true') {
                  try {
                      $hotspotStatus = netsh wlan show hostednetwork | Select-String "Status" | ForEach-Object { $_.ToString().Split(':')[1].Trim() }
                      $clients = netsh wlan show hostednetwork | Select-String "Number of clients" | ForEach-Object { $_.ToString().Split(':')[1].Trim() }
                      Write-Host "üì∂ Hotspot: $hotspotStatus (Clientes: $clients)"
                  } catch {
                      Write-Host "üì∂ Hotspot: No disponible"
                  }
              }
              
              Write-Host "üíª Instrucci√≥n: Conecta dispositivos para compartir internet"
              Write-Host "---------------------------"
              Start-Sleep -Seconds 30
          }
          
          Write-Host "üö´ Sesi√≥n RDP finalizada"
          Write-Host "üì¥ Desconectando compartir internet..."
          
          # Limpiar configuraci√≥n
          if ($env:HOTSPOT_ENABLED -eq 'true') {
              netsh wlan stop hostednetwork
          }
