name: Windows RDP via Tailscale

on:
  workflow_dispatch:

jobs:
  windows-rdp:
    runs-on: windows-latest
    timeout-minutes: 30

    steps:
    - name: Configure Windows RDP
      run: |
        Write-Host "üîß Configurando RDP..."
        # Habilitar RDP
        Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server' -Name "fDenyTSConnections" -Value 0
        # No requerir autenticaci√≥n a nivel de red
        Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp' -Name "UserAuthentication" -Value 0
        # Permitir conexiones sin NLA
        Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp' -Name "SecurityLayer" -Value 0
        
        # Configurar firewall
        netsh advfirewall firewall set rule group="remote desktop" new enable=Yes
        netsh advfirewall firewall add rule name="RDP-Tailscale" dir=in action=allow protocol=TCP localport=3389
        
        # Reiniciar servicio Terminal Services
        Restart-Service TermService -Force
        Start-Service SessionEnv
        Write-Host "‚úÖ RDP configurado"

    - name: Create local user for RDP
      run: |
        Write-Host "üë§ Creando usuario RDP..."
        $Password = ConvertTo-SecureString "RDPpassword123!" -AsPlainText -Force
        New-LocalUser -Name "rdpuser" -Password $Password -AccountNeverExpires
        Add-LocalGroupMember -Group "Administrators" -Member "rdpuser"
        Add-LocalGroupMember -Group "Remote Desktop Users" -Member "rdpuser"
        Write-Host "‚úÖ Usuario creado: rdpuser / RDPpassword123!"

    - name: Install Tailscale
      run: |
        Write-Host "üì• Instalando Tailscale..."
        $TailscaleURL = "https://pkgs.tailscale.com/stable/tailscale-setup-amd64.msi"
        $InstallerPath = "$env:TEMP\tailscale.msi"
        
        # Descargar Tailscale
        Invoke-WebRequest -Uri $TailscaleURL -OutFile $InstallerPath
        
        # Instalar silenciosamente
        Start-Process msiexec.exe -Wait -ArgumentList @(
            "/i",
            "`"$InstallerPath`"",
            "/quiet",
            "/norestart"
        )
        
        # Esperar a que se instale
        Start-Sleep -Seconds 10
        Remove-Item $InstallerPath -Force
        Write-Host "‚úÖ Tailscale instalado"

    - name: Connect to Tailscale
      run: |
        Write-Host "üîó Conectando a Tailscale..."
        
        # Conectar a Tailscale
        & "C:\Program Files\Tailscale\tailscale.exe" up --auth-key=${{ secrets.TAILSCALE_AUTH_KEY }} --hostname=github-rdp-${{ github.run_id }}
        
        # Esperar conexi√≥n
        Start-Sleep -Seconds 15
        
        # Obtener IP de Tailscale
        $TailscaleIP = & "C:\Program Files\Tailscale\tailscale.exe" ip -4
        if (-not $TailscaleIP) {
            Write-Host "‚ö†Ô∏è Obteniendo IP de Tailscale (reintentando)..."
            Start-Sleep -Seconds 10
            $TailscaleIP = & "C:\Program Files\Tailscale\tailscale.exe" ip -4
        }
        
        if ($TailscaleIP) {
            Write-Host "‚úÖ Tailscale IP: $TailscaleIP"
            echo "TAILSCALE_IP=$TailscaleIP" >> $env:GITHUB_ENV
        } else {
            Write-Host "‚ùå No se pudo obtener IP de Tailscale"
            echo "TAILSCALE_IP=ERROR" >> $env:GITHUB_ENV
        }

    - name: Display connection information
      run: |
        Write-Host ""
        Write-Host "üéâ CONEXI√ìN RDP LISTA üéâ"
        Write-Host "=================================================="
        Write-Host "üìç DIRECCI√ìN: $env:TAILSCALE_IP"
        Write-Host "üë§ USUARIO: rdpuser"
        Write-Host "üîë CONTRASE√ëA: RDPpassword123!"
        Write-Host "=================================================="
        Write-Host ""
        Write-Host "üìù INSTRUCCIONES:"
        Write-Host "1. Abre 'Conexi√≥n a Escritorio Remoto'"
        Write-Host "2. Pega esta IP: $env:TAILSCALE_IP"
        Write-Host "3. Usuario: rdpuser"
        Write-Host "4. Contrase√±a: RDPpassword123!"
        Write-Host ""
        Write-Host "‚è∞ Esta sesi√≥n estar√° activa por 25 minutos"
        Write-Host ""

    - name: Keep RDP session alive
      run: |
        Write-Host "üîÑ Manteniendo sesi√≥n RDP activa..."
        $StartTime = Get-Date
        $EndTime = $StartTime.AddMinutes(25)
        
        while ((Get-Date) -lt $EndTime) {
            $TimeLeft = $EndTime - (Get-Date)
            $MinutesLeft = [math]::Floor($TimeLeft.TotalMinutes)
            $SecondsLeft = $TimeLeft.Seconds
            
            # Verificar estado de Tailscale
            $CurrentIP = & "C:\Program Files\Tailscale\tailscale.exe" ip -4 2>$null
            
            Write-Host "‚è±Ô∏è Tiempo restante: $MinutesLeft min $SecondsLeft seg | IP: $CurrentIP"
            
            # Mantener servicios activos
            Get-Service TermService | Set-Service -Status Running -ErrorAction SilentlyContinue
            
            Start-Sleep -Seconds 30
        }
        
        Write-Host "üõë Sesi√≥n RDP finalizada"
