name: RDP with Hotspot

on:
  workflow_dispatch:

jobs:
  secure-rdp:
    runs-on: windows-latest
    timeout-minutes: 35

    steps:
      - name: Configure Core RDP Settings
        run: |
          Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server' -Name "fDenyTSConnections" -Value 0 -Force
          Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp' -Name "UserAuthentication" -Value 0 -Force
          Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp' -Name "SecurityLayer" -Value 0 -Force

          netsh advfirewall firewall delete rule name="RDP-Tailscale"
          netsh advfirewall firewall add rule name="RDP-Tailscale" dir=in action=allow protocol=TCP localport=3389

          Restart-Service -Name TermService -Force

      - name: Create RDP User with Secure Password
        run: |
          # Generar contrase√±a m√°s simple y visible
          $password = "RDP123!password"
          
          # Crear usuario
          $securePass = ConvertTo-SecureString $password -AsPlainText -Force
          New-LocalUser -Name "RDPUser" -Password $securePass -AccountNeverExpires
          Add-LocalGroupMember -Group "Administrators" -Member "RDPUser"
          Add-LocalGroupMember -Group "Remote Desktop Users" -Member "RDPUser"
          
          # Mostrar contrase√±a CLARAMENTE en los logs
          Write-Host "=========================================="
          Write-Host "CREDENCIALES RDP - COPIA Y PEGA:"
          Write-Host "USUARIO: RDPUser"
          Write-Host "CONTRASE√ëA: RDP123!password"
          Write-Host "=========================================="
          
          # Tambi√©n guardar en variables
          echo "RDP_USER=RDPUser" >> $env:GITHUB_ENV
          echo "RDP_PASSWORD=RDP123!password" >> $env:GITHUB_ENV

      - name: Install Tailscale
        run: |
          $tsUrl = "https://pkgs.tailscale.com/stable/tailscale-setup-latest-amd64.msi"
          $installerPath = "$env:TEMP\tailscale.msi"
          Invoke-WebRequest -Uri $tsUrl -OutFile $installerPath
          Start-Process msiexec.exe -ArgumentList "/i", "`"$installerPath`"", "/quiet", "/norestart" -Wait
          Remove-Item $installerPath -Force

      - name: Check Hotspot Hardware Support
        id: check_hotspot
        run: |
          Write-Host "üîç Verificando compatibilidad con Hotspot..."
          
          # Verificar drivers de WiFi
          $wlanDrivers = netsh wlan show drivers
          $hostedNetworkSupported = $wlanDrivers | Select-String "Hosted network supported" | ForEach-Object { $_.ToString().Split(':')[1].Trim() }
          
          # Verificar adaptadores WiFi disponibles
          $wifiAdapters = Get-NetAdapter | Where-Object { $_.InterfaceDescription -like "*wireless*" -or $_.InterfaceDescription -like "*wifi*" -or $_.Name -like "*Wi-Fi*" }
          $hasWifiAdapter = ($wifiAdapters | Measure-Object).Count -gt 0
          
          # Verificar si hay interfaces virtuales existentes
          $hostedInterfaces = Get-NetAdapter | Where-Object { $_.InterfaceDescription -like "*Hosted*" }
          
          Write-Host "üìä Resultados de compatibilidad:"
          Write-Host "   - Soporte de red alojada: $hostedNetworkSupported"
          Write-Host "   - Adaptadores WiFi encontrados: $($wifiAdapters.Count)"
          Write-Host "   - Interfaces alojadas existentes: $($hostedInterfaces.Count)"
          
          $hotspotSupported = ($hostedNetworkSupported -eq "Yes") -and $hasWifiAdapter
          
          if ($hotspotSupported) {
              Write-Host "‚úÖ El hardware SOPORTA Hotspot WiFi"
              echo "HOTSPOT_SUPPORTED=true" >> $env:GITHUB_ENV
          } else {
              Write-Host "‚ùå El hardware NO SOPORTA Hotspot WiFi"
              Write-Host "üí° Se usar√° solo RDP a trav√©s de Tailscale"
              echo "HOTSPOT_SUPPORTED=false" >> $env:GITHUB_ENV
          }

      - name: Configure Hotspot WiFi (si est√° soportado)
        if: env.HOTSPOT_SUPPORTED == 'true'
        run: |
          # Configurar hotspot WiFi
          $hotspotName = "GitHubRDP-Hotspot"
          $hotspotPassword = "Hotspot123!"
          
          Write-Host "üîß Configurando Hotspot WiFi..."
          
          try {
              # Detener hotspot existente si hay
              netsh wlan stop hostednetwork 2>$null
              
              # Configurar nuevo hotspot
              $setResult = netsh wlan set hostednetwork mode=allow ssid=$hotspotName key=$hotspotPassword
              Write-Host "Configuraci√≥n hotspot: $setResult"
              
              # Iniciar hotspot
              $startResult = netsh wlan start hostednetwork
              Write-Host "Inicio hotspot: $startResult"
              
              # Esperar a que se active
              Start-Sleep -Seconds 3
              
              # Verificar estado
              $status = netsh wlan show hostednetwork | Select-String "Status" | ForEach-Object { $_.ToString().Split(':')[1].Trim() }
              
              if ($status -eq "Started") {
                  Write-Host "‚úÖ Hotspot WiFi activado correctamente"
                  Write-Host "üì∂ SSID: $hotspotName"
                  Write-Host "üîë Password: $hotspotPassword"
                  
                  echo "HOTSPOT_SSID=$hotspotName" >> $env:GITHUB_ENV
                  echo "HOTSPOT_PASSWORD=$hotspotPassword" >> $env:GITHUB_ENV
                  echo "HOTSPOT_STATUS=active" >> $env:GITHUB_ENV
              } else {
                  Write-Host "‚ùå No se pudo iniciar el hotspot. Estado: $status"
                  echo "HOTSPOT_STATUS=failed" >> $env:GITHUB_ENV
              }
              
          } catch {
              Write-Host "‚ùå Error configurando hotspot: $($_.Exception.Message)"
              echo "HOTSPOT_STATUS=error" >> $env:GITHUB_ENV
          }

      - name: Configure Alternative Network Sharing
        if: env.HOTSPOT_SUPPORTED == 'false'
        run: |
          Write-Host "üîÑ Configurando alternativa de red..."
          
          # Crear informaci√≥n de red local simulada
          $localNetworkInfo = @"
üì° CONFIGURACI√ìN DE RED ALTERNATIVA
================================
Como el hardware no soporta Hotspot WiFi, puedes:

1. **CONEXI√ìN DIRECTA RDP:**
   - Usa la IP de Tailscale proporcionada abajo
   - Todo el tr√°fico ya est√° protegido por VPN

2. **COMPARTIR CONEXI√ìN MANUALMENTE:**
   - Conecta otro dispositivo a Tailscale
   - Usa la misma red VPN segura
   - Accede al RDP desde cualquier dispositivo en Tailscale

3. **USO M√öLTIPLE DISPOSITIVOS:**
   - A√±ade m√°s dispositivos a tu red Tailscale
   - Todos podr√°n acceder al RDP de forma segura
"@
          
          Write-Host $localNetworkInfo
          echo "NETWORK_ALTERNATIVE=true" >> $env:GITHUB_ENV

      - name: Establish Tailscale Connection
        run: |
          & "$env:ProgramFiles\Tailscale\tailscale.exe" up --authkey=${{ secrets.TAILSCALE_AUTH_KEY }} --hostname=gh-runner-$env:GITHUB_RUN_ID --advertise-exit-node
          
          $tsIP = $null
          $retries = 0
          while (-not $tsIP -and $retries -lt 10) {
              $tsIP = & "$env:ProgramFiles\Tailscale\tailscale.exe" ip -4
              Start-Sleep -Seconds 5
              $retries++
          }
          
          if (-not $tsIP) {
              Write-Error "Tailscale IP not assigned. Exiting."
              exit 1
          }
          echo "TAILSCALE_IP=$tsIP" >> $env:GITHUB_ENV
          Write-Host "Tailscale IP: $tsIP"

      - name: Display Final Connection Info
        run: |
          Write-Host ""
          Write-Host "üéØ CONEXI√ìN RDP LISTA"
          Write-Host "================================================"
          Write-Host "üìç DIRECCI√ìN RDP: $env:TAILSCALE_IP"
          Write-Host "üë§ USUARIO: RDPUser"
          Write-Host "üîë CONTRASE√ëA: RDP123!password"
          Write-Host ""
          
          if ($env:HOTSPOT_STATUS -eq 'active') {
              Write-Host "üì∂ HOTSPOT WIFI ACTIVO:"
              Write-Host "   SSID: $env:HOTSPOT_SSID"
              Write-Host "   PASSWORD: $env:HOTSPOT_PASSWORD"
              Write-Host "   üì° Con√©ctate a este WiFi para acceso local"
          } elseif ($env:HOTSPOT_SUPPORTED -eq 'false') {
              Write-Host "üí° MODO SIN HOTSPOT:"
              Write-Host "   Este runner no tiene hardware WiFi compatible"
              Write-Host "   ‚úÖ Usa RDP directamente con la IP de Tailscale"
              Write-Host "   üîó Puedes conectar m√∫ltiples dispositivos a Tailscale"
          } else {
              Write-Host "‚ö†Ô∏è  Hotspot no disponible"
              Write-Host "   ‚úÖ RDP funciona perfectamente via Tailscale"
          }
          
          Write-Host "================================================"
          Write-Host ""
          Write-Host "üìù INSTRUCCIONES RDP:"
          Write-Host "1. Abre 'Conexi√≥n a Escritorio Remoto'"
          Write-Host "2. Pega la direcci√≥n: $env:TAILSCALE_IP"
          Write-Host "3. Usuario: RDPUser"
          Write-Host "4. Contrase√±a: RDP123!password"
          Write-Host ""
          
          if ($env:HOTSPOT_STATUS -eq 'active') {
              Write-Host "üì° INSTRUCCIONES HOTSPOT:"
              Write-Host "1. Busca WiFi: $env:HOTSPOT_SSID"
              Write-Host "2. Contrase√±a: $env:HOTSPOT_PASSWORD"
              Write-Host "3. Luego conecta via RDP a: $env:TAILSCALE_IP"
          }

      - name: Monitor Connections
        run: |
          $endTime = (Get-Date).AddMinutes(30)
          Write-Host "‚è∞ Sesi√≥n activa por 30 minutos - Termina a las $($endTime.ToString('HH:mm:ss'))"
          
          while ((Get-Date) -lt $endTime) {
              $remaining = $endTime - (Get-Date)
              $minutes = [math]::Floor($remaining.TotalMinutes)
              $seconds = $remaining.Seconds
              
              # Mostrar estado de conexiones
              Write-Host "--- Estado de la sesi√≥n ---"
              Write-Host "‚è±Ô∏è  Tiempo restante: $minutes min $seconds seg"
              
              # Verificar estado de Tailscale
              try {
                  $tsStatus = & "$env:ProgramFiles\Tailscale\tailscale.exe" status --json | ConvertFrom-Json
                  Write-Host "üîó Tailscale: $($tsStatus.BackendState)"
              } catch {
                  Write-Host "üîó Tailscale: Error verificando estado"
              }
              
              # Verificar estado del hotspot si est√° activo
              if ($env:HOTSPOT_STATUS -eq 'active') {
                  try {
                      $hotspotStatus = netsh wlan show hostednetwork | Select-String "Status" | ForEach-Object { $_.ToString().Split(':')[1].Trim() }
                      $clients = netsh wlan show hostednetwork | Select-String "Number of clients" | ForEach-Object { $_.ToString().Split(':')[1].Trim() }
                      Write-Host "üì∂ Hotspot: $hotspotStatus (Clientes: $clients)"
                  } catch {
                      Write-Host "üì∂ Hotspot: Error verificando estado"
                  }
              }
              
              Write-Host "---------------------------"
              Start-Sleep -Seconds 30
          }
          
          Write-Host "üö´ Sesi√≥n RDP finalizada"
          
          # Apagar hotspot al finalizar si estaba activo
          if ($env:HOTSPOT_STATUS -eq 'active') {
              try {
                  netsh wlan stop hostednetwork
                  Write-Host "üì¥ Hotspot apagado"
              } catch {
                  Write-Host "‚ö†Ô∏è  Error apagando hotspot"
              }
          }
